<!doctype html>
<html>
  <head>
    <title>Social Squares</title>
  </head>
  <body>
    <style>
      .socSquare{
      width:30px;
      height:30px;
      position:absolute;
      }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <script>
      var running = false;
      var repeat;

      var squareClients = []; //Array to hold all the clients
      var server = io(); //Server io

      var socialSquare = {//Base object for the squares
        id        : 0,
        yOff   : 0,
        xOff   : 0,
        xPos    : 0,
        yPos    : 0
      }

      var localSquareID = "#";
      var localSquareNum = 0;

      var relativePos = [0,0];

      var heightOffset, widthOffset, yOffset, xOffset;
      function genRandomPos(){
        return Math.floor(Math.random()*1000);
      }
      function getRandomColor(){
        //Generates a random 6 digit number to be used as a color
        var num = Math.floor(Math.random() * (999999-111111)) + 111111;
        return "#" + num;
      }
      function createSocialSquare(id){
        //Creates a new element for the client
        console.log("CREATING SQUARE WITH ID:",id)
        var appendString = "<div id = " + id + " class = socSquare></div>";
        $("body").append(appendString)
        $("#" + id).css("left", id*50);
        //Generates a random color for the square
        var color = getRandomColor();
        $("#" + id).css("background-color", color);
        //Create the social square object to store
        newSquare = Object.create(socialSquare);
        newSquare.id = id;
        //Push the newly created square into the array
        squareClients.push(newSquare);
      }

      var pos = [0,0];

      function rePositionSquare(){
        heightOffset = parseInt($(localSquareID).css("height"), 10)/2;
        widthOffset = parseInt($(localSquareID).css("width"), 10)/2;
        pos[0] = Math.floor(window.innerHeight/2 - heightOffset);
        pos[1] = Math.floor(window.innerWidth/2 - widthOffset);
        $(localSquareID).css("top", pos[0]);
        $(localSquareID).css("left", pos[1]);
      }

      $(window).resize(function(){
        rePositionSquare();
      })

      //Creates a new square whenever a user joins
      server.on('userAdded', function(elems){
        createSocialSquare(Number(elems));
      });

      server.on('userCreated', function(elems){
        //Create any squares that are already on the server
        for(var i = 1; i <= elems; i++){
          createSocialSquare(Number(i));
        }
        //create the players socialSquare
        localSquareNum = Number(elems) + 1;
        createSocialSquare(localSquareNum);
        localSquareID += (localSquareNum);

        rePositionSquare();
      });
      var offsets = [0,0];
      $(document).mousemove(function(event){
        //Stores new mouse position in an array
        yOffset = event.pageY - 15 - parseInt($(localSquareID).css("top"), 10);
        xOffset = event.pageX - 15 - parseInt($(localSquareID).css("left"), 10);
        offsets[0] = yOffset/-100;
        offsets[1] = xOffset/-100;
        server.emit('mouseMove', offsets);
        if(!running){
          repeat = setInterval(update, 10);
          console.log("setting interval");
          running = true;
        }
      });

      //Listens to the server, waiting for a client to move its mouse
      server.on('clientMoved', function(clientInfo){
        squareClients[(clientInfo[2])-1].yOff = clientInfo[0];
        squareClients[(clientInfo[2])-1].xOff = clientInfo[1];
      });

      //Listens to the server, waiting for a client to leave
      server.on('clientLeft', function(id){
        //Generates the element ID to delete, then deletes it
        var delID = "#" + (Number(id) + 1);
        $(delID).remove();
        console.log("Removing client", delID)
        //Change local square id if needed
        if(localSquareNum > (id + 1)){
          localSquareNum--;
          localSquareID = "#" + localSquareNum;
        }
        //Remove square from array, and shift elements overs
        squareClients.splice(id, 1);
        for(var i = id; i < squareClients.length; i++){
          $("#"+squareClients[i].id).attr ("id", Number(i+1));
          squareClients[i].id -= 1;
        }
      });
      var cssIDRel;
      var curPos = [0,0];
      //var lastMousePos = mousePos;
      function update(){
        //console.log("meep");
        for(var i = 0; i < squareClients.length; i++){
          if((i + 1) != localSquareNum){
            cssIDRel = "#" + Number(i + 1);
            curPos[0] = parseInt($(cssIDRel).css("top"), 10);
            curPos[1] = parseInt($(cssIDRel).css("left"), 10);
           // console.log(squareClients[i].yOff + " " + squareClients[i].xOff);
            $(cssIDRel).css("top", curPos[0] - squareClients[i].yOff + (yOffset/-100));
            $(cssIDRel).css("left", curPos[1]  - squareClients[i].xOff + (xOffset/-100));
          }
        }
      }
    </script>
  </body>
</html>