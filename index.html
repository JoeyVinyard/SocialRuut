
<!doctype html>
<html>
  <head>
    <title>Social Squares</title>
  </head>
  <body>
    <div id = "test"></div>
    <style>
      .socSquare{
        width:30px;
        height:30px;
        position:absolute;
      }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.0/TweenMax.min.js"></script>
    <script>
      var squareClients = []; //Array to hold all the clients
      var server = io(); //Server io

      var socialSquare = {//Base object for the squares
        id        : 0,
        mouseXPos : 0,
        mouseYPos : 0
      }

      var localSquareID = "#";
      var localSquareNum = 0;

      var relativePos = [0,0];

      var heightOffset, widthOffset, yOffset, xOffset;

      function getRandomColor(){
        //Generates a random 6 digit number to be used as a color
        var num = Math.floor(Math.random() * (999999-111111)) + 111111;
        return "#" + num;
      }
      function createSocialSquare(id){
        //Creates a new element for the client
        console.log("CREATING SQUARE WITH ID:",id)
        var appendString = "<div id = " + id + " class = socSquare></div>";
        $("body").append(appendString)
        $("#" + id).css("left", id*50);
        //Generates a random color for the square
        var color = getRandomColor();
        $("#" + id).css("background-color", color);
        //Create the social square object to store
        newSquare = Object.create(socialSquare);
        newSquare.id = id;
        newSquare.mouseXPos = id*50;
        //Push the newly created square into the array
        squareClients.push(newSquare);
      }

      function rePositionSquare(){
        heightOffset = parseInt($(localSquareID).css("height"), 10)/2;
        widthOffset = parseInt($(localSquareID).css("width"), 10)/2;
        relativePos[0] = Math.floor(window.innerHeight/2 - heightOffset);
        relativePos[1] = Math.floor(window.innerWidth/2 - widthOffset);
        $(localSquareID).css("top", relativePos[0]);
        $(localSquareID).css("left", relativePos[1]);
      }

      $(window).resize(function(){
        rePositionSquare();
      })

      //Creates a new square whenever a user joins
      server.on('userAdded', function(elems){
          createSocialSquare(Number(elems));
      });

      server.on('userCreated', function(elems){

        //Create any squares that are already on the server
        for(var i = 1; i <= elems; i++){
          createSocialSquare(Number(i));
        }
        //create the players socialSquare
        localSquareNum = Number(elems) + 1;
        createSocialSquare(localSquareNum);
        localSquareID += (localSquareNum);
        
        rePositionSquare();
      });

      var mousePos = [];
      $(document).mousemove(function(event){
        //Stores new mouse position in an array
        yOffset = event.pageY - 15 - parseInt($(localSquareID).css("top"), 10);
        xOffset = event.pageX - 15 - parseInt($(localSquareID).css("left"), 10);
        mousePos[0] = event.pageY-15;
        mousePos[1] = event.pageX-15;
        //Move the locally stored client based on mouse movement
        // TweenMax.to( $(localSquareID), 2, {
        //   css: { left: mousePos[1], top: mousePos[0] },
        //   ease: Linear.easeOut
        // });
        //Send the server the mouse position
        server.emit('mouseMove', mousePos);
      });

      //Listens to the server, waiting for a client to move its mouse
      server.on('clientMoved', function(clientInfo){
        squareClients[(clientInfo[2]-1)].mouseYPos = clientInfo[0];
        squareClients[(clientInfo[2]-1)].mouseXPos = clientInfo[1];
        //Generates the element ID to manipulate
        //var cssID = "#" + Number(clientInfo[2]);
        //Moves the other squares, based on passed information
        // TweenMax.to( $(cssID), 2, {
        //   css: { left: clientInfo[1], top: clientInfo[0] },
        //   ease: Linear.easeOut
        // });
      });

      //Listens to the server, waiting for a client to leave
      server.on('clientLeft', function(id){
        //Generates the element ID to delete, then deletes it
        var delID = "#" + (Number(id) + 1);
        $(delID).remove();
        console.log("Removing client", delID)
        //Change local square id if needed
        if(localSquareNum > (id + 1)){
          localSquareNum--;
          localSquareID = "#" + localSquareNum;
        }
        //Remove square from array, and shift elements overs
        squareClients.splice(id, 1);
        for(var i = id; i < squareClients.length; i++){
          $("#"+squareClients[i].id).attr ("id", Number(i+1));
          squareClients[i].id -= 1;
        }
      });
      var cssIDRel;
      var curPos = [0,0];
      window.setInterval(function(){
        for(var i = 1; i <= squareClients.length; i++){
          if(i != localSquareNum){
            cssIDRel = "#" + Number(i);
            curPos[0] = parseInt($(cssIDRel).css("top"), 10);
            curPos[1] = parseInt($(cssIDRel).css("left"), 10);
            $(cssIDRel).css("top", curPos[0] + (yOffset/-100));
            $(cssIDRel).css("left", curPos[1]  + (xOffset/-100));
          }
        }
      }, 10)
    </script>
  </body>
</html>